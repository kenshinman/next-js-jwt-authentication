<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: useAuth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: useAuth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import jwt from "jsonwebtoken";
import cookie from "cookie";
import Cookies from "js-cookie";
import Router from "next/router";
import { sendError } from "next/dist/next-server/server/api-utils";

const isClient = typeof window !== "undefined";

export const useAuth = () => {
	/**
	 * @function
	 * @name useAuth
	 * @param {object} credentials
	 * @param  {string} credentials.email
	 * @param  {string} credentials.password
	 * @description a react hook for authenticating in next.js
	 */
	const logIn = async (credentials) => {
		const { email, password } = credentials;

		const login = new Promise((resolve, reject) => {
			const payload = {
				email,
				name: "Kehinde Orilogbon",
				exp: Math.floor(Date.now() / 1000) + 60 * 60 * 24 * 30,
			};

			//do fake auth
			setTimeout(() => {
				resolve({
					user: { name: "kehinde Orilogbon", email },
					token: jwt.sign(payload, "mySecret"),
				});
			}, 2000);
		});

		const res = await login;
		setSession(res);
	};

	/**
	 * @function
	 * @name logOut
	 * @description clears user's session details and also the redirectTo cookie
	 */
	const logOut = async () => {
		Cookies.remove("token");
		Cookies.remove("user");
		Cookies.remove("redirectTo");
		Router.replace("/");
	};

	/**
	 * @function
	 * @name setSession
	 * @param {object} res an object with the session details like user payload, token, etc
	 * @description Takes the user payload from login or register and sets the user payload
	 * cookie and token.
	 * Axios can also be configured here
	 *
	 */
	const setSession = (res) => {
		const { user, token } = res;
		Cookies.set("user", JSON.stringify(user));
		Cookies.set("token", token);
		const redirectTo = Cookies.get("redirectTo");
		if (redirectTo) {
			Router.push(redirectTo);
		} else {
			Router.push("/");
		}
	};

	/**
	 * @function
	 * @name getSession
	 * @param {object} ctx the app context passed from getServerSideProps
	 * It contains req, res, query, etc read here
	 * @description gets user's session both on client and server side.
	 * First on the client, it gets the cookies from the browser and on the server side, it extracts cookies from ctx.req.header.cookie
	 * After cookies are got and parsed, then it checks if the jwt valid using isValidToken().
	 * If token is valid, it appends the token and user payload to session and returns session
	 * @returns {object} session object
	 */
	const getSession = async (ctx) => {
		//on the server
		const session = {};

		if (isClient) {
			const cookies = Cookies.get();
			const { token, user } = cookies; //user is a string that needs to be parsed
			if (token &amp;&amp; user &amp;&amp; isValidToken(token)) {
				session.token = token;
				session.user = user ? JSON.parse(user) : null;
				session.isAuthenticated = true;
			}
		} else {
			const cookies = cookie.parse(ctx.req.headers?.cookie || "");
			if (cookies.token &amp;&amp; cookies.user) {
				const { token, user } = cookies;
				if (token &amp;&amp; user &amp;&amp; isValidToken(token)) {
					session.user = JSON.parse(cookies.user);
					session.token = cookies.token;
					session.isAuthenticated = true;
				} else {
					return session;
				}
			}
		}
		return session;
	};

	/**
	 * @function
	 * @name isValidToken
	 * @param {string} token
	 * @returns {boolean}
	 * @description returns `true` if token is valid and not expired, but `false` is expired or invalid
	 */
	const isValidToken = async (token) => {
		const payload = jwt.decode(token);
		if (payload) {
			const { exp } = payload;
			return exp * 1000 > Date.now();
		}
	};

	return { logIn, logOut, isValidToken, getSession };
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#getSession">getSession</a></li><li><a href="global.html#isValidToken">isValidToken</a></li><li><a href="global.html#logOut">logOut</a></li><li><a href="global.html#setSession">setSession</a></li><li><a href="global.html#useAuth">useAuth</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Tue Oct 27 2020 00:50:34 GMT+0100 (West Africa Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
